{% extends 'base.html' %}
{% block content %}
<div class="text-center mt-4 bg-blue-500">
  <h2>Welcome, {{ user.username }} ðŸ‘‹</h2>
  <p class="lead text-white">You can buy crypto with Naira via Paystack.</p>

  <form id="buyForm" method="POST" action="{% url 'initialize_paystack' %}">
    {% csrf_token %}
    <label>Select Crypto:</label>
    <select name="crypto" id="crypto">
      <option value="BTC">Bitcoin (BTC)</option>
      <option value="ETH">Ethereum (ETH)</option>
      <option value="USDT">Tether (USDT)</option>
      <option value="USDT">Litecoin (LTC)</option>
    </select>

    <label>Enter Amount (â‚¦):</label>
    <input type="number" id="amount" name="amount" min="1000" required>

    <button type="button" id="quoteBtn" class="btn btn-info mt-2">Get Quote</button>
    <p id="quoteResult"></p>

    <button type="submit" class="btn btn-success mt-3">Pay with Paystack</button>
  </form>
</div>

<hr>

<div>
  <h3>Wallet Balance</h3>
  <p>BTC: {{ wallet.btc_balance }}</p>
  <p>ETH: {{ wallet.eth_balance }}</p>
</div>

<h3 class="mt-4">Transaction History</h3>
<table class="table table-striped">
  <thead>
    <tr>
      <th>Crypto</th>
      <th>Amount</th>
      <th>Amount (â‚¦)</th>
      <th>Status</th>
      <th>Date</th>
    </tr>
  </thead>
  <tbody>
    {% for cryptotransaction in cryptotransactions %}
    <tr>
      <td>{{ cryptotransaction.get_crypto_symbol_display }}</td>
      <td>{{ cryptotransaction.amount_crypto }}</td>
      <td>{{ cryptotransaction.amount_naira }}</td>
      <td>{{ cryptotransaction.status }}</td>
      <td>{{ cryptotransaction.created_at|date:"Y-m-d H:i" }}</td>
    </tr>
    {% empty %}
    <tr><td colspan="5" class="text-center">No transactions yet.</td></tr>
    {% endfor %}
  </tbody>
</table>

<!-- <script>
document.getElementById("quoteBtn").onclick = function() {
  const symbol = document.getElementById("crypto").value;
  const amount = document.getElementById("amount").value;
  fetch(`/api/price-quote/?symbol=${symbol}&amount=${amount}`)
  .then(res => res.json())
  .then(data => {
    document.getElementById("quoteResult").innerText =
      `1 ${symbol} = â‚¦${data.price_naira.toLocaleString()} | Youâ€™ll get ${data.crypto_amount} ${symbol}`;
  });
};
</script> -->
<script>
document.getElementById("payButton").addEventListener("click", function() {
    const crypto_symbol = document.getElementById("crypto_symbol").value;
    const amount_naira = document.getElementById("amount_naira").value;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    if (!amount_naira || !crypto_symbol) {
        alert("Please select a crypto and enter an amount.");
        return;
    }

    fetch("/api/initialize-paystack/", {
        method: "POST",
        headers: {
            "X-CSRFToken": csrfToken,
            "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({
            crypto_symbol: crypto_symbol,
            amount_naira: amount_naira,
        }),
    })
    .then(res => res.json())
    .then(data => {
        if (data.authorization_url) {
            window.location.href = data.authorization_url;
        } else {
            alert(data.error || "Something went wrong.");
        }
    })
    .catch(err => {
        alert("Network error: " + err.message);
    });
});
</script>

{% endblock %}
